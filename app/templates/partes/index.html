{% extends "base.html" %}
{% import "_forms.html" as forms %}
{% block content %}
<h1>Partes diarios</h1>
<form method="get" class="mb-3 filters">
  <label>Del <input type="date" name="d1" value="{{ d1 or '' }}"></label>
  <label>al <input type="date" name="d2" value="{{ d2 or '' }}"></label>
  <input name="q" value="{{ q }}" placeholder="Buscar por código o tipo de equipo...">
  <button type="submit">Filtrar</button>
  {% if DEV_MODE %}
  <a class="btn" href="{{ url_for('partes.nuevo') }}">Nuevo</a>
  {% endif %}
  <a class="btn" href="{{ url_for('partes.export_csv', d1=d1, d2=d2, q=q) }}">Exportar CSV</a>
</form>
<p>
  <strong>Total horas:</strong> {{ '%.2f'|format(total_horas) }} —
  <strong>Combustible (L):</strong> {{ '%.2f'|format(total_comb) }}
</p>
<table class="table">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Equipo</th>
      <th>Operador</th>
      <th>Turno</th>
      <th>Horas</th>
      <th>Comb (L)</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
  {% for r in rows %}
    <tr>
      <td>{{ r.fecha }}</td>
      <td>{{ r.equipo.codigo if r.equipo else r.equipo_id }}</td>
      <td>{{ r.operador.nombre if r.operador else '-' }}</td>
      <td>{{ r.turno }}</td>
      <td>{{ '%.2f'|format(r.horas_trabajadas) if r.horas_trabajadas is not none else '-' }}</td>
      <td>{{ '%.2f'|format(r.combustible_l) if r.combustible_l is not none else '-' }}</td>
      <td>
        <a href="{{ url_for('partes.detalle', parte_id=r.id) }}">Ver</a>
        {% if DEV_MODE %}
          <a href="{{ url_for('partes.editar', parte_id=r.id) }}">Editar</a>
          <form action="{{ url_for('partes.eliminar', parte_id=r.id) }}" method="post" style="display:inline">
            {{ forms.csrf_field() }}
            <button type="submit" onclick="return confirm('¿Eliminar parte?')">Eliminar</button>
          </form>
        {% endif %}
      </td>
    </tr>
  {% else %}
    <tr><td colspan="7">No hay partes registrados.</td></tr>
  {% endfor %}
  </tbody>
</table>
{% if pagination.pages > 1 %}
<nav class="pagination">
  {% if pagination.has_prev %}
  <a href="{{ url_for('partes.index', page=pagination.prev_num, q=q, d1=d1, d2=d2, per_page=pagination.per_page) }}">« Anterior</a>
  {% endif %}
  <span>Página {{ pagination.page }} de {{ pagination.pages }}</span>
  {% if pagination.has_next %}
  <a href="{{ url_for('partes.index', page=pagination.next_num, q=q, d1=d1, d2=d2, per_page=pagination.per_page) }}">Siguiente »</a>
  {% endif %}
</nav>
{% endif %}
{% endblock %}
