{% extends "base.html" %}
{% block content %}
<h1 class="page-title">Partes diarias</h1>

<form method="get" class="mb-3" action="{{ url_for('partes.index') }}">
  <label>Desde</label>
  <input type="date" name="desde" value="{{ desde.isoformat() if desde else '' }}">
  <label>Hasta</label>
  <input type="date" name="hasta" value="{{ hasta.isoformat() if hasta else '' }}">
  <label>Equipo</label>
  <select name="equipo_id">
    <option value="">-- todos --</option>
    {% for e in equipos %}
      <option value="{{ e.id }}" {% if equipo_id and equipo_id == e.id %}selected{% endif %}>
        {{ e.codigo }} #{{ e.id }}
      </option>
    {% endfor %}
  </select>
  <button type="submit">Filtrar</button>
  <a href="{{ url_for('partes.export_csv', desde=desde.isoformat() if desde else None, hasta=hasta.isoformat() if hasta else None, equipo_id=equipo_id) }}">Exportar CSV</a>
  <a href="{{ url_for('partes.resumen', desde=desde.isoformat() if desde else None, hasta=hasta.isoformat() if hasta else None, equipo_id=equipo_id) }}">Resumen</a>
  {% if DEV_MODE %}
    <a href="{{ url_for('partes.create') }}">+ Nuevo</a>
  {% endif %}
</form>

<table class="table">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Equipo</th>
      <th>Operador</th>
      <th>Horas</th>
      <th>Actividad</th>
      <th>Incidencias</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
    <tr>
      <td>{{ r.fecha }}</td>
      <td>{{ r.equipo.codigo if r.equipo else r.equipo_id }}</td>
      <td>{{ r.operador.nombre if r.operador else r.operador_id }}</td>
      <td>{{ '%.2f'|format(r.horas_trabajo or 0) }}</td>
      <td>{{ r.actividad }}</td>
      <td>{{ r.incidencias }}</td>
      <td style="text-align:right; white-space:nowrap;">
        {% set s = evidencias_summary(parte_id=r.id) %}
        <a class="btn" href="{{ url_for('archivos_bp.index', parte_id=r.id)|replace('/?', '?') }}"
           title="Tamaño total: {{ s.size_h }}">
          Evidencias <span class="badge">{{ s.total }}</span>
          <span class="badge-wrap">
            <span class="badge badge--pdf">PDF {{ s.by_ext.pdf }}</span>
            <span class="badge badge--img">IMG {{ s.by_ext.img }}</span>
          </span>
        </a>
        {% if DEV_MODE %}
        <a href="{{ url_for('partes.pdf_parte', id=r.id) }}" target="_blank">PDF</a>
        <a href="{{ url_for('partes.edit', id=r.id) }}">Editar</a>
        <form method="post" action="{{ url_for('partes.delete', id=r.id) }}" style="display:inline" onsubmit="return confirm('¿Eliminar parte?');">
          <button type="submit">Eliminar</button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% if pagination.pages > 1 %}
<nav>
  {% if pagination.has_prev %}
    <a href="{{ url_for('partes.index', page=pagination.prev_num, desde=desde.isoformat() if desde else None, hasta=hasta.isoformat() if hasta else None, equipo_id=equipo_id) }}">&laquo; Anterior</a>
  {% endif %}
  <span>Página {{ pagination.page }} de {{ pagination.pages }}</span>
  {% if pagination.has_next %}
    <a href="{{ url_for('partes.index', page=pagination.next_num, desde=desde.isoformat() if desde else None, hasta=hasta.isoformat() if hasta else None, equipo_id=equipo_id) }}">Siguiente &raquo;</a>
  {% endif %}
</nav>
{% endif %}
{% endblock %}
