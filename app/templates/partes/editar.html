{% extends "base.html" %}
{% block content %}
<h1>Parte — {{ p.fecha }} — Equipo {{ p.equipo.codigo if p.equipo else p.equipo_id }}</h1>
<form method="post" action="{{ url_for('partes.actualizar', parte_id=p.id) }}" class="form-grid">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <label>Fecha: <input type="date" name="fecha" value="{{ p.fecha }}"></label>
  <label>Equipo:
    <select name="equipo_id">
      {% for e in equipos %}
        <option value="{{ e.id }}" {% if e.id == p.equipo_id %}selected{% endif %}>{{ e.codigo }} — {{ e.tipo }}</option>
      {% endfor %}
    </select>
  </label>
  {% if operadores %}
  <label>Operador:
    <select name="operador_id">
      <option value="">—</option>
      {% for o in operadores %}
        <option value="{{ o.id }}" {% if p.operador_id == o.id %}selected{% endif %}>{{ o.nombre }}</option>
      {% endfor %}
    </select>
  </label>
  {% endif %}
  <label>Turno: <input name="turno" value="{{ p.turno }}"></label>
  <label>Ubicación: <input name="ubicacion" value="{{ p.ubicacion or '' }}"></label>
  <label>Clima: <input name="clima" value="{{ p.clima or '' }}"></label>
  <label>Inicio: <input name="horas_inicio" type="number" step="0.1" value="{{ p.horas_inicio or '' }}"></label>
  <label>Fin: <input name="horas_fin" type="number" step="0.1" value="{{ p.horas_fin or '' }}"></label>
  <label>Horas trab.: <input name="horas_trabajadas" type="number" step="0.1" value="{{ p.horas_trabajadas or '' }}"></label>
  <label>Combustible (L): <input name="combustible_l" type="number" step="0.1" value="{{ p.combustible_l or '' }}"></label>
  <label>Observaciones: <input name="observaciones" value="{{ p.observaciones or '' }}"></label>
  <div class="form-actions">
    <button type="submit">Guardar</button>
    <a class="btn" href="{{ url_for('partes.detalle', parte_id=p.id) }}">Ver detalle</a>
  </div>
</form>
<form method="post" action="{{ url_for('partes.eliminar', parte_id=p.id) }}" onsubmit="return confirm('¿Eliminar parte?');">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <button type="submit" class="btn btn-danger">Eliminar parte</button>
</form>

<h2>Actividades</h2>
<table class="table">
  <thead>
    <tr><th>Descripción</th><th>Cantidad</th><th>Unidad</th><th>Horas</th><th>Notas</th><th></th></tr>
  </thead>
  <tbody>
  {% for a in actividades %}
    <tr>
      <td>{{ a.descripcion }}</td>
      <td>{{ '%.2f'|format(a.cantidad) if a.cantidad is not none else '-' }}</td>
      <td>{{ a.unidad or '-' }}</td>
      <td>{{ '%.2f'|format(a.horas) if a.horas is not none else '-' }}</td>
      <td>{{ a.notas or '' }}</td>
      <td>
        <form method="post" action="{{ url_for('partes.eliminar_actividad', parte_id=p.id, act_id=a.id) }}" onsubmit="return confirm('¿Eliminar actividad?');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit">Eliminar</button>
        </form>
      </td>
    </tr>
  {% else %}
    <tr><td colspan="6">Sin actividades registradas.</td></tr>
  {% endfor %}
  </tbody>
</table>

<h3>Agregar actividad</h3>
<form method="post" action="{{ url_for('partes.agregar_actividad', parte_id=p.id) }}" class="form-grid">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input name="descripcion" placeholder="Descripción" required>
  <input name="cantidad" type="number" step="0.01" placeholder="Cantidad">
  <input name="unidad" placeholder="Unidad (m3, viajes, etc.)">
  <input name="horas" type="number" step="0.1" placeholder="Horas">
  <input name="notas" placeholder="Notas">
  <button type="submit">Agregar</button>
</form>
{% endblock %}
