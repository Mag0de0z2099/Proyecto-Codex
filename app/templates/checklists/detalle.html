{% extends "base.html" %}
{% block content %}
<h1>{{ cl.template.name }} — {{ cl.date }} — <strong>{{ cl.overall_status }}</strong></h1>
<p>
  {% if parte %}
    Vinculado a Parte <a href="{{ url_for('partes.detalle', parte_id=parte.id) }}">#{{ parte.id }}</a>
    {% if DEV_MODE %}<a href="{{ url_for('partes.editar', parte_id=parte.id) }}">(editar)</a>{% endif %}
  {% else %}
    {% if DEV_MODE %}
    <form method="post" action="{{ url_for('checklists.generar_parte', cl_id=cl.id) }}" style="display:inline">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit">Generar Parte Diario</button>
    </form>
    {% endif %}
  {% endif %}
</p>
{% if DEV_MODE %}
<p>
  <a href="{{ url_for('checklists.editar', cl_id=cl.id) }}">Editar checklist</a>
</p>
{% endif %}
<p>
  Equipo: {{ cl.equipment.codigo if cl.equipment else cl.equipment_id }} |
  Turno: {{ cl.shift }} |
  Ubicación: {{ cl.location }} |
  Clima: {{ cl.weather }}
</p>
{% for section, items in items_by_section.items() %}
  <h2>{{ "Pre-operativo" if section == "PRE" else ("Operación" if section == "OP" else "Post-operativo") }}</h2>
  <table>
    <thead>
      <tr><th>#</th><th>Ítem</th><th>Res</th><th>Nota</th><th>Foto</th></tr>
    </thead>
    <tbody>
    {% for it in items %}
      {% set a = answers.get(it.id) %}
      <tr>
        <td>{{ it.order }}</td>
        <td>{{ it.text }} {% if it.critical %}<strong>(Crítico)</strong>{% endif %}</td>
        <td>{{ a.result.value if a else '-' }}</td>
        <td>{{ a.note if a else '' }}</td>
        <td>
          {% if a and a.photo_path %}
            <a href="{{ url_for('checklists.photo', fname=a.photo_path) }}" target="_blank">ver</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% endfor %}
<button type="button" onclick="window.print()">Imprimir</button>
{% endblock %}
