{% extends "layout.html" %}
{% block content %}
<h1 class="page-title">Dashboard (DEV)</h1>
<p class="muted">Modo DEV: {{ 'ON' if DEV_MODE else 'OFF' }}</p>

<div class="cards">
  <a class="card" href="{{ url_for('equipos_bp.index') }}">Equipos <b>{{ counts.get('equipos') }}</b></a>
  <a class="card" href="{{ url_for('operadores_bp.index') }}">Operadores <b>{{ counts.get('operadores') }}</b></a>
  <a class="card" href="{{ url_for('partes.index') }}">Partes <b>{{ counts.get('partes') }}</b></a>
  <a class="card" href="{{ url_for('checklists_bp.templates_index') }}">Plantillas <b>{{ counts.get('plantillas') }}</b></a>
  <a class="card" href="{{ url_for('checklists_bp.runs_index') }}">Ejecuciones <b>{{ counts.get('checklist_runs') }}</b></a>
  <a class="card" href="{{ url_for('operadores_bp.index', vence_en=30) }}">Licencias por vencer (30d) <b>{{ counts.get('lic_por_vencer_30') }}</b></a>
  <a class="card" href="{{ url_for('operadores_bp.index', vencidas=1) }}">Licencias vencidas <b>{{ counts.get('lic_vencidas') }}</b></a>
</div>

<form method="get" action="{{ url_for('dashboard_bp.index') }}" class="section">
  <label class="muted">Rango:</label>
  <select name="days" onchange="this.form.submit()">
    {% for d in [7,14,30,60,90] %}
      <option value="{{ d }}" {% if days==d %}selected{% endif %}>{{ d }} días</option>
    {% endfor %}
  </select>
  <a class="card" style="display:inline-block;padding:6px 10px" href="{{ url_for('dashboard_bp.export_kpis') }}">CSV KPIs</a>
</form>

<div class="grid">
  <div class="cell">
    <h3>Horas trabajadas ({{ days }} días)</h3>
    <div class="canvas-wrap"><canvas id="chartHoras"></canvas></div>
  </div>
  <div class="cell">
    <h3>% OK Checklists ({{ days }} días)</h3>
    <div class="canvas-wrap"><canvas id="chartPctOk"></canvas></div>
  </div>
  <div class="cell">
    <h3>Top 5 equipos por horas ({{ days }} días)</h3>
    <div class="canvas-wrap"><canvas id="chartTopEquipos"></canvas></div>
  </div>
  <div class="cell">
    <h3>Incidencias en partes ({{ days }} días)</h3>
    <div class="canvas-wrap"><canvas id="chartIncid"></canvas></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels14={{ labels_14|tojson }}, horas14={{ horas_14|tojson }}, pctok14={{ pctok_14|tojson }};
const topLabels={{ top_labels|tojson }}, topData={{ top_data|tojson }}, incidPie={{ incid_pie|tojson }};

new Chart(document.getElementById('chartHoras'),{type:'line',data:{labels:labels14,datasets:[{label:'Horas',data:horas14,tension:.25}]},options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}}}});
new Chart(document.getElementById('chartPctOk'),{type:'line',data:{labels:labels14,datasets:[{label:'% OK',data:pctok14,tension:.25}]},options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{suggestedMin:0,suggestedMax:100}}}});
new Chart(document.getElementById('chartTopEquipos'),{type:'bar',data:{labels:topLabels,datasets:[{label:'Horas',data:topData}]} ,options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
new Chart(document.getElementById('chartIncid'),{type:'doughnut',data:{labels:['Con incidencias','Sin incidencias'],datasets:[{data:incidPie}]} ,options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
</script>
{% endblock %}
