<!doctype html>
<html lang="es">
{% import "_icons.html" as i %}
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}SGC — Obra de Dragado{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
</head>
<body>
  <header class="navbar">
    <div class="nav-left">
      <span class="brand">
        <img class="logo" src="{{ url_for('static', filename='img/siglo21.png') }}" alt="Siglo 21">
        <span>SGC-Obra</span>
      </span>
    </div>
    <nav class="nav-right">
      {% set is_logged = current_user.is_authenticated or session.get('user') %}
      {% set session_user = session.get('user') or {} %}
      {% set current_role = None %}
      {% if current_user.is_authenticated %}
        {% set current_role = current_user.role %}
      {% elif session_user %}
        {% set current_role = session_user.get('role') or ('admin' if session_user.get('is_admin') else None) %}
      {% endif %}
      <a class="btn btn-outline" href="{{ url_for('equipos.index') }}">
        <span>Equipos</span>
      </a>
      <a class="btn btn-outline" href="{{ url_for('partes.index') }}">
        <span>Partes</span>
      </a>
      <a class="btn btn-outline" href="{{ url_for('checklists.index') }}">
        <span>Checklists</span>
      </a>
      <a class="btn btn-outline" href="{{ url_for('operadores.index') }}">
        <span>Operadores</span>
      </a>
      <div class="toolbar" style="margin-left:auto">
        {% if is_logged %}
          {% if current_role == "admin" %}
            <a class="btn btn-outline" href="{{ url_for('admin.users_pending') }}">
              {{ i.bell() }} <span>Pendientes{% if pending_users_count %} ({{ pending_users_count }}){% endif %}</span>
            </a>
          {% endif %}
          <a class="btn btn-outline" href="{{ url_for('admin.dashboard') }}">
            {{ i.userShield() }} <span>Admin</span>
          </a>
          <form method="post" action="{{ url_for('auth.logout') }}" class="inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-primary" type="submit">
              {{ i.logout() }} <span>Logout</span>
            </button>
          </form>
        {% else %}
          <a class="btn btn-primary" href="{{ url_for('auth.login') }}">
            {{ i.key() }} <span>Login</span>
          </a>
        {% endif %}
      </div>
    </nav>
  </header>

  <main class="container">
    <nav>
      <a href="{{ url_for('equipos.index') }}">Equipos</a> |
      <a href="{{ url_for('operadores.index') }}">Operadores</a> |
      <a href="{{ url_for('checklists.index') }}">Checklists</a> |
      <a href="{{ url_for('partes.index') }}">Partes</a>
    </nav>
    <hr>
    {% if current_user.is_authenticated and (current_user.is_approved is defined) and not current_user.is_approved %}
      <div class="alert alert-warning" role="status">
        Tu cuenta aún no ha sido aprobada. Algunas secciones pueden estar bloqueadas.
      </div>
    {% endif %}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-stack">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <footer class="footer">
    <small>© 2025 SGC — Control de Calidad y Seguridad en Obra de Dragado</small>
  </footer>
</body>
</html>
