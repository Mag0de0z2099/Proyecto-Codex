{% extends "base.html" %}
{% import "_forms.html" as forms %}
{% block content %}
<h1 class="page-title">Operadores</h1>

<form method="get" class="mb-3" action="{{ url_for('operadores_bp.index') }}">
  <input type="text" name="q" value="{{ q or '' }}" placeholder="Buscar nombre, doc o notas">
  <select name="vence_en">
    <option value="">Vencen en...</option>
    {% for d in [7, 15, 30, 60, 90] %}
      <option value="{{ d }}" {% if vence_en == d %}selected{% endif %}>{{ d }} días</option>
    {% endfor %}
  </select>
  <button type="submit">Filtrar</button>
  <a href="{{ url_for('operadores_bp.export_csv', q=q, vence_en=vence_en) }}">Exportar CSV</a>
  {% if DEV_MODE %}<a href="{{ url_for('operadores_bp.create') }}">+ Nuevo</a>{% endif %}
</form>

<table class="table">
  <thead>
    <tr><th>ID</th><th>Nombre</th><th>Doc</th><th>Licencia vence</th><th>Días</th><th>Estatus</th>{% if DEV_MODE %}<th>Acciones</th>{% endif %}</tr>
  </thead>
  <tbody>
    {% for r in rows %}
    {% set d = r.dias_para_vencer() %}
    <tr {% if d is not none and d <= 15 %}style="background:#fff3cd"{% endif %}>
      <td>{{ r.id }}</td>
      <td>{{ r.nombre }}</td>
      <td>{{ r.doc_id }}</td>
      <td>{{ r.licencia_vence or '' }}</td>
      <td>{{ d if d is not none else '' }}</td>
      <td>{{ r.estatus }}</td>
      {% if DEV_MODE %}
      <td>
        <a href="{{ url_for('operadores_bp.edit', operador_id=r.id) }}">Editar</a>
        <form method="post" action="{{ url_for('operadores_bp.delete', operador_id=r.id) }}" style="display:inline" onsubmit="return confirm('¿Eliminar operador?');">
          {{ forms.csrf_field() }}
          <button type="submit">Eliminar</button>
        </form>
      </td>
      {% endif %}
    </tr>
    {% else %}
    <tr>
      <td colspan="{{ 7 if DEV_MODE else 6 }}">No hay operadores registrados.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% if pagination.pages > 1 %}
<nav>
  {% if pagination.has_prev %}<a href="{{ url_for('operadores_bp.index', page=pagination.prev_num, q=q, vence_en=vence_en) }}">&laquo; Anterior</a>{% endif %}
  <span>Página {{ pagination.page }} de {{ pagination.pages }}</span>
  {% if pagination.has_next %}<a href="{{ url_for('operadores_bp.index', page=pagination.next_num, q=q, vence_en=vence_en) }}">Siguiente &raquo;</a>{% endif %}
</nav>
{% endif %}
{% endblock %}
