{% extends "admin/_base_admin.html" %}
{% import "_icons.html" as i %}
{% block admin_content %}
<h1>Usuarios</h1>

<div class="stack-v">
  <div class="toolbar">
    <a href="{{ url_for('admin.admin_new_user') }}" class="btn btn-primary btn-wide">➕ Crear usuario</a>
  </div>

  <form method="get" class="filters stack-h gap-2">
    <div>
      <label for="q">Buscar</label>
      <input id="q" type="search" name="q" value="{{ q or '' }}" placeholder="Correo o usuario">
    </div>
    <div>
      <label for="status">Estado</label>
      <select id="status" name="status">
        <option value="" {{ 'selected' if not status else '' }}>Todos</option>
        <option value="pending" {{ 'selected' if status == 'pending' else '' }}>Pendientes</option>
        <option value="approved" {{ 'selected' if status == 'approved' else '' }}>Aprobados</option>
      </select>
    </div>
    <div>
      <label for="per_page">Por página</label>
      <select id="per_page" name="per_page">
        {% for size in (5, 10, 20, 50, 100) %}
          <option value="{{ size }}" {{ 'selected' if meta.per_page == size else '' }}>{{ size }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="align-end">
      <button type="submit" class="btn btn-outline">Aplicar</button>
    </div>
  </form>

  <div class="table-grid header-8">
    <div class="th">Usuario</div>
    <div class="th">Rol</div>
    <div class="th">Estado</div>
    <div class="th">Categoría</div>
    <div class="th">Aprobado</div>
    <div class="th">Activo</div>
    <div class="th">Cambiar rol</div>
    <div class="th">Acciones</div>

    {% for u in users %}
      <div>
        <div>{{ u.username }}</div>
        <small>{{ u.email or '—' }}</small>
      </div>

      <div>{{ u.role or 'viewer' }}</div>

      <div>
        <span class="badge badge-{{ 'success' if u.status == 'approved' else 'secondary' }}">{{ u.status }}</span>
      </div>

      <div>{{ u.category or '—' }}</div>

      <div>
        {% if u.approved_at %}
          {{ u.approved_at.strftime('%Y-%m-%d %H:%M') }}
        {% else %}
          —
        {% endif %}
      </div>

      <div>{{ 'Sí' if u.is_active else 'No' }}</div>

      {% if current_user.role == 'admin' %}
        <div class="btn-group">
          <form method="post" action="{{ url_for('admin.users_set_role') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="user_id" value="{{ u.id }}">
            <select name="role">
              {% for r in ROLES %}
                <option value="{{ r }}" {{ 'selected' if (u.role or 'viewer') == r else '' }}>{{ r }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-outline btn-wide" type="submit" title="Guardar rol">
              {{ i.save() }} <span>Guardar</span>
            </button>
          </form>
        </div>

        <div class="btn-group">
          <form method="post" action="{{ url_for('admin.users_toggle_active') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="user_id" value="{{ u.id }}">
            <button class="btn btn-outline btn-wide" type="submit" title="{{ 'Desactivar' if u.is_active else 'Activar' }} usuario {{ u.username }}">
              {{ i.power() }} <span>{{ 'Desactivar' if u.is_active else 'Activar' }}</span>
            </button>
          </form>
        </div>

        <div class="btn-group">
          <form method="post" action="{{ url_for('admin.admin_user_reset_link', user_id=u.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-outline btn-sm btn-wide" type="submit" title="Enviar reset">
              {{ i.refresh() }} <span>Enviar reset</span>
            </button>
          </form>
          <form method="post" action="{{ url_for('admin.admin_user_toggle_force', user_id=u.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-outline btn-sm btn-wide" type="submit" title="{{ 'Quitar forzar' if u.force_change_password else 'Forzar cambio' }}">
              {{ i.key() }} <span>{{ 'Quitar forzar' if u.force_change_password else 'Forzar cambio' }}</span>
            </button>
          </form>
        </div>
      {% else %}
        <div>—</div>
        <div>—</div>
        <div>—</div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="stack-h space-between align-center mt-3">
    <div>
      Total: <strong>{{ meta.total }}</strong> · Página {{ meta.page }} de {{ meta.pages }}
    </div>
    <div class="stack-h gap-2">
      {% if meta.page > 1 %}
        <a class="btn btn-outline" href="{{ url_for('admin.users', status=status or None, q=q or None, per_page=meta.per_page, page=meta.page - 1) }}">◀ Anterior</a>
      {% endif %}
      {% if meta.page < meta.pages %}
        <a class="btn btn-outline" href="{{ url_for('admin.users', status=status or None, q=q or None, per_page=meta.per_page, page=meta.page + 1) }}">Siguiente ▶</a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
